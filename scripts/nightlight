#!/bin/bash

LOCKFILE="/tmp/nightlight-monitor.lock"

exec 9>"$LOCKFILE" || exit 1
flock -n 9 || exit 0

export DISPLAY=:0
export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$(id -u)/bus"

STATE="unknown" # on | off

while true; do
    HOUR=$(date +%H)

    if [ "$HOUR" -ge 19 ] || [ "$HOUR" -lt 8 ]; then
        if [ "$STATE" != "on" ]; then
            xsct 3500
            notify-send --urgency=normal --expire-time=3000 "Night Light" "Night light ON: Time $(date +%H:%M)"
            STATE="on"
        fi
    else
        if [ "$STATE" != "off" ]; then
            xsct 6500
            notify-send --urgency=normal --expire-time=3000 "Night Light" "Night light OFF: Time $(date +%H:%M)"
            STATE="off"
        fi
    fi

    sleep 1200
done
